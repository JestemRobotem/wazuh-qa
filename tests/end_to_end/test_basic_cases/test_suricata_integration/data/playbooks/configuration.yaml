- name: Configure Ubuntu agent environment
  hosts: ubuntu-agent
  become: true
  vars:
    suricata_conf_path: /etc/suricata/suricata.yaml
    suricata_log_path: /var/log/suricata/suricata.log
  tasks:

    - name: Configure Wazuh to read Suricata logs file
      blockinfile:
        path: /var/ossec/etc/ossec.conf
        marker: <!-- {mark} READ SURICATA LOGS CONFIG -->
        insertbefore: ^</ossec_config>
        block: |
          <localfile>
          <log_format>syslog</log_format>
          <location>/var/log/suricata/eve.json</location>
          </localfile>

    - name: Restart Wazuh to apply the change
      systemd:
        state: restarted
        name: wazuh-agent

    - name: Check if Suricata is installed
      shell: dpkg -l suricata | grep suricata
      register: check_suricata
      ignore_errors: true

    - name: Add the repo to install Suricata
      shell: |
        add-apt-repository ppa:oisf/suricata-stable -y
      when: '"no packages found matching suricata" in check_suricata.stderr'

    - name: Install Suricata
      package:
        name: suricata
        state: present
      when: '"no packages found matching suricata" in check_suricata.stderr'

    - name: Enable and stop Suricata
      systemd:
        daemon_reload: true
        enabled: true
        state: stopped
        name: suricata

    - name: Change the default interface
      replace:
        path: "{{ suricata_conf_path }}"
        regexp: 'af-packet:\n  - interface: eth0'
        replace: 'af-packet:\n  - interface: {{ ansible_default_ipv4.interface }}'

    - name: Configure external network in Suricata
      replace:
        path: "{{ suricata_conf_path }}"
        regexp: 'EXTERNAL_NET: "!\$HOME_NET"'
        replace: 'EXTERNAL_NET: "any"'

    - name: Configure rules path in Suricata
      replace:
        path: "{{ suricata_conf_path }}"
        regexp: 'default-rule-path: \S.*\n\nrule-files:\n.*- suricata.rules'
        replace: 'default-rule-path: /var/lib/suricata/rules\n\nrule-files:\n  - "*.rules"'

    - name: Configure live rule reloading
      blockinfile:
        path: "{{ suricata_conf_path }}"
        insertafter: EOF
        block: "detect-engine:\n  - rule-reload: true"

    - name: Clean Suricata logs
      shell: echo '' >  "{{ suricata_log_path }}"

    - name: Updating Suricata rules
      shell: suricata-update

    - name: Start Suricata
      systemd:
        state: started
        name: suricata

    - name: Wait for Suricata to start completely
      wait_for:
        path: "{{ suricata_log_path }}"
        search_regex: <Info> - All AFP capture threads are running.
