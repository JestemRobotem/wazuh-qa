- name: Configure manager environment
  hosts: manager
  become: true
  tasks:

    - name: Configure Virustotal integration and active response
      blockinfile:
        path: /var/ossec/etc/ossec.conf
        insertbefore: </ossec_config>
        block: |
          <integration>
          <name>virustotal</name>
          <api_key>{{ virustotal_key }}</api_key>
          <rule_id>100200,100201</rule_id>
          <alert_format>json</alert_format>
          </integration>

          <command>
          <name>remove-threat</name>
          <executable>remove-threat.sh</executable>
          <timeout_allowed>no</timeout_allowed>
          </command>

          <active-response>
          <disabled>no</disabled>
          <command>remove-threat</command>
          <location>local</location>
          <rules_id>87105</rules_id>
          </active-response>
        marker: <!-- {mark} ANSIBLE MANAGED BLOCK -->

    - name: Configure local rules virus total integration
      become: true
      blockinfile:
        path: /var/ossec/etc/rules/local_rules.xml
        insertafter: </groups>
        block: |
          <group name="syscheck,pci_dss_11.5,nist_800_53_SI.7,">
          <!-- Rules for Linux systems -->
          <rule id="100200" level="7">
          <if_sid>550</if_sid>
          <field name="file">/root</field>
          <description>File modified in /root directory.</description>
          </rule>
          <rule id="100201" level="7">
          <if_sid>554</if_sid>
          <field name="file">/root</field>
          <description>File added to /root directory.</description>
          </rule>
          </group>
          <group name="virustotal,">
          <rule id="100092" level="12">
          <if_sid>657</if_sid>
          <match>Successfully removed threat</match>
          <description>$(parameters.program) removed threat located at $(parameters.alert.data.virustotal.source.file)
          </description>
          </rule>
          <rule id="100093" level="12">
          <if_sid>657</if_sid>
          <match>Error removing threat</match>
          <description>Error removing threat located at $(parameters.alert.data.virustotal.source.file)</description>
          </rule>
          </group>
        marker: <!-- {mark} ANSIBLE MANAGED BLOCK -->

    - name: Truncate alert.json
      shell: echo "" > /var/ossec/logs/alerts/alerts.json

    - name: Restart the manager
      shell: systemctl restart wazuh-manager

- name: Configure CentOS agent environment
  hosts: centos-agent
  become: true
  tasks:

    - name: Configure syscheck
      blockinfile:
        path: /var/ossec/etc/ossec.conf
        insertafter: </directories>
        block: |
          <directories whodata="yes">/root</directories>
        marker: <!-- {mark} ANSIBLE MANAGED BLOCK -->

    - name: Add active response script
      become: true
      shell: |
        curl {{ s3_url }}/virustotal_integration/remove-threat.sh -o /var/ossec/active-response/bin/remove-threat.sh

    - name: Install jq
      become: true
      shell: yum install -y jq
      when: ansible_facts['distribution'] == "CentOS"

    - name: Change remove-threat.sh owner and permissions
      become: true
      shell: |
        chmod 750 /var/ossec/active-response/bin/remove-threat.sh
        chown root:wazuh /var/ossec/active-response/bin/remove-threat.sh

    - name: Restart the agent
      shell: systemctl restart wazuh-agent
