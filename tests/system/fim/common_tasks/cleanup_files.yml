- hosts: agents

  tasks:

  - name: check if wazuh-agent service exists
    stat: path=/etc/init.d/wazuh-agent
    register: agent_service_status

  - name: stop wazuh-agent service
    service:
      name: "{{ item }}"
      state: stopped
    with_items:
      - wazuh-agent
    when: agent_service_status.stat.exists


  - name: uninstall wazuh-agent service
    package:
      name: "{{ item }}"
      state: absent
    with_items:
      - wazuh-agent

  - name: ensure /var/ossec is deleted
    file:
      path: /var/ossec
      state: absent

- hosts: managers
  gather_facts: yes

  tasks:

  - name: check if wazuh-manager service exists
    stat: path=/etc/init.d/wazuh-manager
    register: manager_service_status

  - name: check if wazuh-api service exists
    stat: path=/etc/init.d/wazuh-api
    register: api_service_status

  - name: check if filebeat service exists
    stat: path=/etc/init.d/filebeat
    register: filebeat_service_status

  - name: stop wazuh stack services (wazuh-manager, wazuh-api, and, filebeat)
    service:
      name: "{{ item }}"
      state: stopped
    with_items:
      - wazuh-manager
      - wazuh-api
      - filebeat
    when:
      - manager_service_status.stat.exists
      - api_service_status.exists
      - filebeat_service_status.exists

  - name: uninstall wazuh-manager service
    package:
      name: "{{ item }}"
      state: absent
    with_items:
      - wazuh-manager
    when: manager_service_status.stat.exists

  - name: ensure /var/ossec is deleted
    file:
      path: /var/ossec
      state: absent

- hosts: elasticsearch

  tasks:

  - name: get service facts
    service_facts:

  - name: print elasticsearch indexes
    debug: var=ansible_facts.services["elasticsearch.service"]

  - name: list and delete elasticsearch indexes + stop elasticsearch service
    block:
    - name: list Elasticsearch indexes
      command: curl -X GET "{{ ansible_eth1.ipv4.address }}:9200/_cat/indices/*?v&s=index&pretty"
      register: elasticsearch_indexes_get
      delegate_to: "{{ ansible_eth1.ipv4.address }}"

    - name: print elasticsearch indexes
      debug: var={{ item }}
      with_items: elasticsearch_indexes_get.stdout_lines

    - name: delete Elasticsearch indexes
      command:  curl -X DELETE "{{ ansible_eth1.ipv4.address }}:9200/*?pretty"
      register: elasticsearch_indexes_delete
      delegate_to: "{{ ansible_eth1.ipv4.address }}"

    - name: print elasticsearch indexes after deletion
      debug: var={{ item }}
      with_items: elasticsearch_indexes_delete.stdout_lines

    - name: stop elasticsearch service
      service:
        name: "{{ item }}"
        state: stopped
      with_items:
        - elasticsearch
    when: ansible_facts.services["elasticsearch.service"]["state"] == "running"

- hosts: kibana

  tasks:

  - name: check if kibana service exists
    stat: path=/etc/init.d/kibana
    register: kibana_service_status

  - name: stop kibana service
    service:
      name: "{{ item }}"
      state: stopped
    with_items:
      - kibana
    when: kibana_service_status.stat.exists
