---

  - name: Install Nginx
    shell: "amazon-linux-extras install nginx1.12 -y"

  - name: Create SSL required folders
    file:
      path: "{{ item }}"
      state: directory
      mode: '0664'
    with_items:
      - /etc/ssl
      - /etc/ssl/certs
      - /etc/ssl/private

  - name: Generate SSL certificate
    command: "openssl req -x509 -batch -nodes -days 365 -newkey rsa:2048 -keyout /etc/ssl/private/kibana.key -out /etc/ssl/certs/kibana.pem"

  - name: Install htpasswd
    yum:
      name: httpd-tools-2.4.33-2.amzn2.0.2.x86_64
      state: present
    when:
      - ansible_distribution|lower != "amazon"

  - name: Install htpasswd in Amazon Linux
    yum:
      name: httpd-tools-2.4.33-2.amzn2.0.2.x86_64
      state: present
    when:
      - ansible_distribution|lower == "amazon"

  - name: Configure Nginx
    blockinfile:
      path: /etc/nginx/conf.d/kibana.conf
      marker: "# {mark} Ansible managed"
      block: |
        server {
          listen {{ nginx_listen_port }} default_server;
          listen            [::]:{{ nginx_listen_port }};
          access_log            /var/log/nginx/nginx.access.log;
          error_log            /var/log/nginx/nginx.error.log;
          location / {
              proxy_pass {{ kibana_api_protocol }}://{{ hostvars[groups['kibana'][0]]['private_ip'] }}:{{ kibana_port }}/;
          }
        }
      create: yes
    notify: restart nginx