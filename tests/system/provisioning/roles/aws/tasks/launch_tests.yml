---
  - name: Starting SSH and Users unit tests
    block:
      - name: Launching tests to verify user configuration on instances
        shell: >-
            pytest
            --ssh-config={{ ansible_ssh_config_destination }}
            --sudo
            --hosts={{ item }} roles/aws/tests/users.py
            --user={{ ssh_username }}
        with_items: 
          - "{{ groups['masters'] }}"
          - "{{ groups['workers'] }}"
          - "{{ groups['elasticsearch'] }}"
          - "{{ groups['kibana'] }}"
          - "{{ groups['linuxagents'] }}"
        changed_when: False

      - name: Launching tests to verify SSH configuration on instances
        shell: >-
            pytest
            --ssh-config={{ ansible_ssh_config_destination }}
            --sudo
            --hosts={{ item }} roles/aws/tests/ssh.py
            --user={{ ssh_username }}
            --ssh_key='{{ custom_ssh_key }}'
        with_items: 
          - "{{ groups['masters'] }}"
          - "{{ groups['workers'] }}"
          - "{{ groups['elasticsearch'] }}"
          - "{{ groups['kibana'] }}"
          - "{{ groups['linuxagents'] }}"
        changed_when: False
    ignore_errors: yes
    when:
      - test_selector and test_selector == "ssh"
