---
  - name: Testing Route 53 records resolving for Wazuh Demo Environment instances
    shell: "ssh -i {{ ssh_key_path_private }} -o StrictHostKeyChecking=no {{ ssh_username }}{{ '@' }}{{ item }}.{{ environment_type }}"
    async: 10000
    poll: 0
    with_items:
      - "master.wazuh"
      - "worker.wazuh"
      - "elastic-node1.wazuh"
      - "elastic-node2.wazuh"
      - "elastic-node3.wazuh"
      - "kibana.wazuh"
      - "redhat.wazuh"
      - "amazon.wazuh"
      - "debian.wazuh"
      - "ubuntu.wazuh"
      - "centos.wazuh"
    register: playbooks_run
    when:
      - environment_type == "info" or environment_type == "com"
      - test_selector and test_selector == "route53"
    changed_when: False

  - async_status:
      jid: "{{ item.ansible_job_id }}"
    loop: "{{ playbooks_run.results }}"
    register: jobs
    until: jobs.finished
    retries: 5
    delay: 5
    changed_when: False
    when:
      - environment_type == "info" or environment_type == "com"
      - test_selector and test_selector == "route53"

  - name: Verifying the demo.wazuh.com/info does have appropiate certificate
    uri:
      url: "https://demo.wazuh.{{ environment_type}}"
      method: GET
      status_code: 201,302,200
    when:
      - environment_type == "info" or environment_type == "com"
      - test_selector and test_selector == "route53"
