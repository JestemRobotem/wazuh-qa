- name: Generate events
  hosts: manager
  tasks:

    - name: First attempt a RDP brute force attack
      shell: hydra -l {{ item }} -p invalid_password rdp://{{ hostvars['windows-agent']['ansible_host'] }}
      loop:
        - test_user
        - test_user

    # Waiting time after attack to reset active-response timeout (65 seconds because first repeated_offenders is 60 sec)
    - name: Waiting time for the next attack
      pause:
        seconds: 65

    - name: Second attempt a RDP brute force attack
      shell: hydra -l test_user -p invalid_password rdp://{{ hostvars['windows-agent']['ansible_host'] }}

- name: Copy log file to a tmp folder
  hosts: windows-agent
  tasks:

    - name: Get ossec log
      include_role:
        name: manage_logs
        tasks_from: get_log_file.yaml
      vars:
        dest_path: test_recurrent_attacks_after_timeout_expired/
        source_path: C:\Program Files (x86)\ossec-agent\ossec.log
